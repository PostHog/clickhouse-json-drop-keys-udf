#!/usr/bin/env bash
#/ Usage: bin/start [options]
#/ Description: Starts the application in development mode
#/ Options:
#/   -p, --port PORT    Specify port (if applicable)
#/   -e, --env ENV      Specify environment (default: development)
#/   -v, --verbose      Verbose output

source bin/helpers/_utils.sh
set_source_and_root_dir

port=""
env="development"

while (( "$#" )); do
    case "$1" in
        -p|--port)
            port="$2"
            shift 2
            ;;
        -e|--env)
            env="$2"
            shift 2
            ;;
        -v|--verbose)
            export VERBOSE=1
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

print_color blue "Starting application in $env mode..."

# Node.js
if [ -f "package.json" ]; then
    if grep -q '"start"' package.json; then
        if [ -n "$port" ]; then
            export PORT="$port"
        fi
        export NODE_ENV="$env"
        echo "→ Starting Node.js application"
        exec npm start
    elif grep -q '"dev"' package.json; then
        echo "→ Starting Node.js application (dev mode)"
        exec npm run dev
    fi
fi

# Python Flask/Django
if [ -f "manage.py" ]; then
    # Django
    cmd="python3 manage.py runserver"
    if [ -n "$port" ]; then
        cmd="$cmd 0.0.0.0:$port"
    fi
    echo "→ Starting Django application"
    exec $cmd
elif [ -f "app.py" ] || [ -f "main.py" ]; then
    # Flask/FastAPI
    if grep -q "flask" requirements.txt 2>/dev/null; then
        export FLASK_ENV="$env"
        export FLASK_APP="${FLASK_APP:-app.py}"
        cmd="flask run"
        if [ -n "$port" ]; then
            cmd="$cmd --port $port"
        fi
        echo "→ Starting Flask application"
        exec $cmd
    elif grep -q "fastapi" requirements.txt 2>/dev/null; then
        cmd="uvicorn main:app --reload"
        if [ -n "$port" ]; then
            cmd="$cmd --port $port"
        fi
        echo "→ Starting FastAPI application"
        exec $cmd
    else
        echo "→ Starting Python application"
        exec python3 "${MAIN_FILE:-main.py}"
    fi
fi

# Ruby
if [ -f "Gemfile" ]; then
    if [ -f "config.ru" ]; then
        # Rack application (Rails, Sinatra)
        cmd="bundle exec rackup"
        if [ -n "$port" ]; then
            cmd="$cmd -p $port"
        fi
        echo "→ Starting Ruby application"
        exec $cmd
    elif grep -q "rails" Gemfile; then
        cmd="bundle exec rails server"
        if [ -n "$port" ]; then
            cmd="$cmd -p $port"
        fi
        echo "→ Starting Rails application"
        exec $cmd
    fi
fi

# .NET
if compgen -G "*.csproj" > /dev/null; then
    project=$(ls ./*.csproj | grep -v Test | head -1)
    if [ -n "$port" ]; then
        export ASPNETCORE_URLS="http://localhost:$port"
    fi
    export ASPNETCORE_ENVIRONMENT="${env^}"  # Capitalize first letter
    echo "→ Starting .NET application"
    exec dotnet run --project "$project"
fi

# Go
if [ -f "go.mod" ] && [ -f "main.go" ]; then
    if [ -n "$port" ]; then
        export PORT="$port"
    fi
    echo "→ Starting Go application"
    exec go run main.go
fi

# Docker Compose
if [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
    echo "→ Starting with Docker Compose"
    exec docker-compose up
fi

print_color green "✓ Application started"
