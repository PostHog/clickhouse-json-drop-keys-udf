#!/usr/bin/env bash
#/ Usage: bin/lint [options]
#/ Description: Runs all linters and static analysis tools
#/ Options:
#/   --fix         Automatically fix issues where possible
#/   -v, --verbose Verbose output

source bin/helpers/_utils.sh
set_source_and_root_dir

fix=false

while (( "$#" )); do
    case "$1" in
        --fix)
            fix=true
            shift
            ;;
        -v|--verbose)
            export VERBOSE=1
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

print_color blue "Running linters..."

success=true

# JavaScript/TypeScript
if [ -f "package.json" ]; then
    if grep -q '"eslint"' package.json || [ -f ".eslintrc" ] || [ -f ".eslintrc.json" ]; then
        cmd="npx eslint ."
        if $fix; then
            cmd="$cmd --fix"
        fi
        echo "→ Linting JavaScript/TypeScript"
        if ! $cmd; then
            success=false
        fi
    fi

    if command_exists tsc && [ -f "tsconfig.json" ]; then
        echo "→ Type checking TypeScript"
        if ! npx tsc --noEmit; then
            success=false
        fi
    fi
fi

# Python
if command_exists ruff; then
    cmd="ruff check"
    if $fix; then
        cmd="$cmd --fix"
    fi
    echo "→ Linting Python with ruff"
    if ! $cmd .; then
        success=false
    fi
elif command_exists flake8; then
    echo "→ Linting Python with flake8"
    if ! flake8 .; then
        success=false
    fi
elif command_exists pylint; then
    echo "→ Linting Python with pylint"
    if ! pylint ./**/*.py; then
        success=false
    fi
fi

if command_exists mypy && [ -f "mypy.ini" ]; then
    echo "→ Type checking Python"
    if ! mypy .; then
        success=false
    fi
fi

# Ruby
if [ -f "Gemfile" ] && command_exists rubocop; then
    cmd="bundle exec rubocop"
    if $fix; then
        cmd="$cmd --auto-correct"
    fi
    echo "→ Linting Ruby"
    if ! $cmd; then
        success=false
    fi
fi

# Go
if [ -f "go.mod" ]; then
    if command_exists golangci-lint; then
        cmd="golangci-lint run"
        if $fix; then
            cmd="$cmd --fix"
        fi
        echo "→ Linting Go with golangci-lint"
        if ! $cmd; then
            success=false
        fi
    else
        echo "→ Running go vet"
        if ! go vet ./...; then
            success=false
        fi
    fi
fi

# Rust
if [ -f "Cargo.toml" ] && command_exists cargo; then
    echo "→ Linting Rust with clippy"
    if ! cargo clippy -- -D warnings; then
        success=false
    fi
fi

# Shell scripts
if command_exists shellcheck; then
    echo "→ Linting shell scripts"
    if ! shellcheck bin/*; then
        success=false
    fi
fi

# Markdown
if command_exists markdownlint; then
    echo "→ Linting Markdown"
    if ! markdownlint '**/*.md'; then
        success=false
    fi
fi

# YAML
if command_exists yamllint; then
    echo "→ Linting YAML"
    if ! yamllint .; then
        success=false
    fi
fi

if $success; then
    print_color green "✓ All linters passed"
else
    print_color red "✗ Linting issues found"
    exit 1
fi
