#!/usr/bin/env bash
#/ Usage: bin/bootstrap
#/ Description: Resolves all dependencies that the project requires to run
#/
#/ This script is idempotent and safe to run multiple times.

source bin/helpers/_utils.sh
set_source_and_root_dir
parse_common_args "$@"
set -e

print_color blue "Bootstrapping project dependencies..."

# Node.js
if [ -f "package.json" ]; then
    if [ -f "package-lock.json" ]; then
        echo "→ Installing Node.js dependencies (locked)"
        npm ci
    else
        echo "→ Installing Node.js dependencies"
        npm install
    fi
fi

# Python
if [ -f "requirements.txt" ]; then
    echo "→ Installing Python dependencies"
    python3 -m pip install -r requirements.txt
elif [ -f "pyproject.toml" ]; then
    if command_exists poetry; then
        echo "→ Installing Python dependencies with Poetry"
        poetry install
    else
        echo "→ Installing Python dependencies"
        python3 -m pip install .
    fi
elif [ -f "Pipfile" ]; then
    require_commands pipenv
    echo "→ Installing Python dependencies with Pipenv"
    pipenv install
fi

# Ruby
if [ -f "Gemfile" ]; then
    echo "→ Installing Ruby dependencies"
    bundle install
fi

# .NET
if compgen -G "*.sln" > /dev/null; then
    echo "→ Restoring .NET dependencies"
    dotnet restore
fi

# Go
if [ -f "go.mod" ]; then
    echo "→ Downloading Go dependencies"
    go mod download
fi

# Rust
if [ -f "Cargo.toml" ]; then
    echo "→ Fetching Rust dependencies"
    cargo fetch
fi

print_color green "✓ Dependencies installed successfully"
