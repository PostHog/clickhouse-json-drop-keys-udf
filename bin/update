#!/usr/bin/env bash
#/ Usage: bin/update
#/ Description: Updates project dependencies to their latest versions
#/
#/ This script updates dependencies while respecting version constraints.
#/ Always run tests after updating to ensure nothing broke.

source bin/helpers/_utils.sh
set_source_and_root_dir
parse_common_args "$@"
set -e

print_color blue "Updating project dependencies..."

# Node.js
if [ -f "package.json" ]; then
    if [ -f "package-lock.json" ]; then
        echo "→ Updating Node.js dependencies"
        npm update
        echo "→ Fixing security vulnerabilities"
        npm audit fix
    elif [ -f "yarn.lock" ]; then
        echo "→ Updating Node.js dependencies with Yarn"
        yarn upgrade
    elif [ -f "pnpm-lock.yaml" ]; then
        echo "→ Updating Node.js dependencies with pnpm"
        pnpm update
    fi
fi

# Python
if [ -f "requirements.txt" ]; then
    if command_exists pip-compile; then
        echo "→ Updating Python dependencies"
        pip-compile --upgrade requirements.in
    else
        print_color yellow "Consider using pip-tools for better dependency management"
    fi
elif [ -f "pyproject.toml" ] && command_exists poetry; then
    echo "→ Updating Python dependencies with Poetry"
    poetry update
elif [ -f "Pipfile" ] && command_exists pipenv; then
    echo "→ Updating Python dependencies with Pipenv"
    pipenv update
fi

# Ruby
if [ -f "Gemfile" ]; then
    echo "→ Updating Ruby dependencies"
    bundle update
fi

# .NET
if compgen -G "*.sln" > /dev/null || compgen -G "*.csproj" > /dev/null; then
    # Update NuGet packages
    if compgen -G "*.sln" > /dev/null; then
        for sln in *.sln; do
            echo "→ Checking outdated packages"
            dotnet list "$sln" package --outdated
        done
    fi
    print_color yellow "Use 'dotnet add package <name>' to update specific packages"
fi

# Go
if [ -f "go.mod" ]; then
    echo "→ Updating Go dependencies"
    go get -u ./...
    echo "→ Tidying Go modules"
    go mod tidy
fi

# Rust
if [ -f "Cargo.toml" ]; then
    echo "→ Updating Rust dependencies"
    cargo update
fi

# Run bootstrap to ensure everything is properly installed
print_color blue "Running bootstrap to ensure consistency..."
bin/bootstrap

print_color green "✓ Dependencies updated"
print_color yellow "Remember to run 'bin/test' to ensure everything still works!"
